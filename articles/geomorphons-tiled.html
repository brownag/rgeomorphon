<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Parallel and Distributed Processing with 'rgeomorphon' • rgeomorphon</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Parallel and Distributed Processing with 'rgeomorphon'">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">rgeomorphon</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/geomorphons-tiled.html">Parallel and Distributed Processing with 'rgeomorphon'</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/brownag/rgeomorphon/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Parallel and Distributed Processing with 'rgeomorphon'</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/brownag/rgeomorphon/blob/main/vignettes/geomorphons-tiled.Rmd" class="external-link"><code>vignettes/geomorphons-tiled.Rmd</code></a></small>
      <div class="d-none name"><code>geomorphons-tiled.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/brownag/rgeomorphon/" class="external-link">rgeomorphon</a></span><span class="op">)</span></span></code></pre></div>
<p>When working with large Digital Elevation Models (DEMs), calculating
geomorphons can be time-consuming. <code>rgeomorphon</code> can speed up
this process by using parallel and distributed processing. This vignette
explains how to set up and use the tiling and parallel processing
features of the package.</p>
<div class="section level2">
<h2 id="working-with-tiles">Working with Tiles<a class="anchor" aria-label="anchor" href="#working-with-tiles"></a>
</h2>
<p>Parallel processing in <code>rgeomorphon</code> is achieved by
splitting the input raster into smaller tiles. Each tile is then
processed independently on a separate worker. The results are then
combined back into a single, seamless raster.</p>
<p>The number of tiles is estimated using <code><a href="https://rspatial.github.io/terra/reference/mem.html" class="external-link">terra::mem_info()</a></code>
to identify raster memory requirements, amount of free memory, fraction
of memory that can be used by <code>terra</code>, number of “copies” of
the input data raster needed to complete processing, etc.</p>
<p>The tiled approach is used automatically when a raster is too large
to fit in memory. However, you can either directly set the number of
chunks to use, or set other factors related to relative memory usage
constraints.</p>
</div>
<div class="section level2">
<h2 id="the-parallel-ecosystem">The Parallel Ecosystem<a class="anchor" aria-label="anchor" href="#the-parallel-ecosystem"></a>
</h2>
<div class="section level3">
<h3 id="two-layers-of-parallelism">Two Layers of Parallelism<a class="anchor" aria-label="anchor" href="#two-layers-of-parallelism"></a>
</h3>
<p><code>rgeomorphon</code> offers two distinct layers of parallelism to
accelerate calculations. This parallelism allows
<code>rgeomorphon</code> to perform optimally across a range of
hardware, from a personal laptop to a high-performance computing (HPC)
cluster.</p>
<p><code>RcppParallel</code> speeds up the work <em>inside</em> each
tile, while packages from the <a href="https://www.futureverse.org/" class="external-link"><code>futureverse</code></a> allow
you to distribute the processing of multiple tiles across multiple
<strong>R</strong> sessions.</p>
<ol style="list-style-type: decimal">
<li><p><strong>Low-Level Parallelism (within a single chunk):</strong>
At its core, <code>rgeomorphon</code> uses
<strong><code>RcppParallel</code></strong> to execute the main
geomorphon algorithm in C++. This provides efficient, multi-threaded
computation on a single data chunk. When you run
<code><a href="../reference/geomorphons.html">geomorphons()</a></code> on a raster that fits in memory,
<code>RcppParallel</code> will automatically attempt to use multiple CPU
cores to speed up the calculation. This is a form of shared-memory
parallelism that works “out of the box.”</p></li>
<li><p><strong>High-Level Parallelism (across multiple chunks):</strong>
For rasters that are too large to fit in memory,
<code>rgeomorphon</code> divides the data into smaller, independent
tiles. You can control how these independent tiles are processed by
providing a parallel <code>lapply</code>-like function to the
<code>LAPPLY.FUN</code> argument. A great option for this is
<code>future.apply::future.lapply()</code>. There are two key steps to
setting up your <strong>R</strong> session:</p></li>
<li><p><strong>Set a <a href="https://future.futureverse.org/reference/plan.html" class="external-link"><code>future</code></a>
plan:</strong> This tells <strong>R</strong> <em>how</em> to distribute
the tiles. For example, <code>plan(multisession)</code> tells
<code>future</code> to use separate <strong>R</strong> sessions on your
local machine.</p></li>
<li><p><strong>Provide a parallel <code>lapply</code> function:</strong>
You need to pass a parallel-aware loop function to
<code><a href="../reference/geomorphons.html">geomorphons()</a></code> via the <code>LAPPLY.FUN</code>
argument.</p></li>
</ol>
</div>
<div class="section level3">
<h3 id="scaling-up-from-a-laptop-to-a-cluster">Scaling Up: From a Laptop to a Cluster<a class="anchor" aria-label="anchor" href="#scaling-up-from-a-laptop-to-a-cluster"></a>
</h3>
<p>The only piece of code you need to change to switch between different
parallel strategies is the <code><a href="https://future.futureverse.org/reference/plan.html" class="external-link">future::plan()</a></code>. This single
command configures the entire backend. Let’s look at a few common
scenarios.</p>
<div class="section level4">
<h4 id="scenario-1-sequential-processing-no-parallelism">Scenario 1: Sequential Processing (No Parallelism)<a class="anchor" aria-label="anchor" href="#scenario-1-sequential-processing-no-parallelism"></a>
</h4>
<p>To disable all high-level parallelism and process tiles one-by-one in
your main <strong>R</strong> session, you use
<code>plan(sequential)</code>. This is great for debugging or for
situations where the overhead of parallelism isn’t worth it.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org" class="external-link">future</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Process everything in the current R session, one tile after another.</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">sequential</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="scenario-2-local-multicore-processing">Scenario 2: Local Multicore Processing<a class="anchor" aria-label="anchor" href="#scenario-2-local-multicore-processing"></a>
</h4>
<p>Local processing using multiple <strong>R</strong> sessions is the
most common scenario for users with a modern multi-core laptop or
workstation. <code>plan(multisession)</code> starts several new,
independent <strong>R</strong> sessions in the background on your local
machine. Each session will work on a different tile of the raster.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Use 4 background R sessions on this computer</span></span>
<span><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<p>On this backend, the low-level <code>RcppParallel</code> engine
within each worker will still try to use multiple threads, so they will
be competing for the same CPU cores. Even so, this is a simple and
effective way to parallelize on a single machine.</p>
</div>
<div class="section level4">
<h4 id="scenario-3-distributed-cluster-processing">Scenario 3: Distributed Cluster Processing<a class="anchor" aria-label="anchor" href="#scenario-3-distributed-cluster-processing"></a>
</h4>
<p>If you have access to a High-Performance Computing (HPC) cluster or
several machines on a network, you can use the <code>cluster</code>
backend. The <code>future</code> framework will handle the logistics of
sending individual tiles to different machines for processing.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Distribute work to two specific machines on the local network</span></span>
<span><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">cluster</span>, workers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"machine1.local"</span>, <span class="st">"machine2.local"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>In this setup, <code>rgeomorphon</code> will send a tile to
<code>machine1.local</code>. Once it arrives, the
<code>RcppParallel</code> engine on <code>machine1.local</code> will
take over and use all of its local cores to process that tile as fast as
possible. This allows you to scale your processing power far beyond the
limits of a single computer.</p>
</div>
</div>
<div class="section level3">
<h3 id="the-geomorphons-call-stays-the-same">The <code>geomorphons()</code> Call Stays the Same<a class="anchor" aria-label="anchor" href="#the-geomorphons-call-stays-the-same"></a>
</h3>
<p>Regardless of which of the backends you configure with
<code><a href="https://future.futureverse.org/reference/plan.html" class="external-link">future::plan()</a></code>, your call to <code><a href="../reference/geomorphons.html">geomorphons()</a></code>
remains identical.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">g_forms</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geomorphons.html">geomorphons</a></span><span class="op">(</span></span>
<span>    <span class="va">my_large_dem</span>,</span>
<span>    search <span class="op">=</span> <span class="fl">50</span>,</span>
<span>    LAPPLY.FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span>, <span class="va">FUN</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu">future.apply</span><span class="fu">::</span><span class="fu"><a href="https://future.apply.futureverse.org/reference/future_lapply.html" class="external-link">future_lapply</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">FUN</span>, future.seed <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">...</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Remember to always return to a sequential plan to shut down workers</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">sequential</span><span class="op">)</span></span></code></pre></div>
<p>To learn more about the different <code>future</code> backends and
their configuration options (including for job schedulers like Slurm or
TORQUE), we highly recommend exploring the documentation and vignettes
on the official <strong><a href="https://future.futureverse.org/" class="external-link"><code>future</code> package
website</a></strong>.</p>
</div>
</div>
<div class="section level2">
<h2 id="demo-with-salton">Demo with <code>salton</code><a class="anchor" aria-label="anchor" href="#demo-with-salton"></a>
</h2>
<p>Let’s demonstrate this with the <code>salton</code> dataset included
with <code>rgeomorphon</code>. This dataset is small and would not
normally trigger tiled processing.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/brownag/rgeomorphon/" class="external-link">rgeomorphon</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## terra 1.8.60</span></span></code></pre>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org" class="external-link">future</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.apply.futureverse.org" class="external-link">future.apply</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load the salton dataset and prepare it as a SpatRaster</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"salton"</span>, package <span class="op">=</span> <span class="st">"rgeomorphon"</span><span class="op">)</span></span>
<span><span class="va">dem</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">salton</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dem</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"Elevation"</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html" class="external-link">crs</a></span><span class="op">(</span><span class="va">dem</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">salton</span>, <span class="st">"crs"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="va">dem</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">salton</span>, <span class="st">"extent"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># By default, this small raster is processed in a single chunk</span></span>
<span><span class="fu"><a href="../reference/geomorphon_chunks_needed.html">geomorphon_chunks_needed</a></span><span class="op">(</span><span class="va">dem</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 1</span></span></code></pre>
<p>To force tiled processing we can manipulate the environment variables
that <code>rgeomorphon</code> uses to estimate memory needs. We will set
<code>R_RGEOMORPHON_MEM_SCALE_NEED</code> to tell the function how much
memory the processing of the input raster will need. This scaling factor
is the number of equivalent “copies” of the input data you need to
process it.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Scale up the memory needed (equivalent to number of input raster copies)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html" class="external-link">Sys.setenv</a></span><span class="op">(</span>R_RGEOMORPHON_MEM_SCALE_NEED <span class="op">=</span> <span class="fl">1e7</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># which will cause the chunking algorithm to divide the raster</span></span>
<span><span class="fu"><a href="../reference/geomorphon_chunks_needed.html">geomorphon_chunks_needed</a></span><span class="op">(</span><span class="va">dem</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 17</span></span></code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Unset the environment variable</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html" class="external-link">Sys.unsetenv</a></span><span class="op">(</span><span class="st">"R_RGEOMORPHON_MEM_SCALE_NEED"</span><span class="op">)</span></span></code></pre></div>
<p>We can also pass the <code>nchunk</code> argument directly to
<code><a href="../reference/geomorphons.html">geomorphons()</a></code> to bypass the memory-based heuristics.</p>
<p>Now that <code><a href="../reference/geomorphons.html">geomorphons()</a></code> will use a tiled approach, we can
set up our parallel plan and execute the calculation.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set up a multisession future plan with 4 workers</span></span>
<span><span class="co"># This creates 4 background R sessions to do the work</span></span>
<span><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<p>Use the LAPPLY.FUN argument to pass
<code><a href="https://future.apply.futureverse.org/reference/future_lapply.html" class="external-link">future.apply::future_lapply</a></code>. This tells
<code><a href="../reference/geomorphons.html">geomorphons()</a></code> to use the future backend for processing
tiles</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">g_parallel</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geomorphons.html">geomorphons</a></span><span class="op">(</span></span>
<span>        <span class="va">dem</span>,</span>
<span>        search <span class="op">=</span> <span class="fl">10</span>,</span>
<span>        flat <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>        LAPPLY.FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span>, <span class="va">FUN</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="fu">future.apply</span><span class="fu">::</span><span class="fu"><a href="https://future.apply.futureverse.org/reference/future_lapply.html" class="external-link">future_lapply</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">FUN</span>, future.seed <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">...</span><span class="op">)</span></span>
<span>        <span class="op">}</span>,</span>
<span>        nchunk <span class="op">=</span> <span class="fl">2</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##   1.787   0.254  13.474</span></span></code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Shut down the parallel workers</span></span>
<span><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">sequential</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Inspect</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">g_parallel</span>, main <span class="op">=</span> <span class="st">"Geomorphons via Tiled Processing"</span><span class="op">)</span></span></code></pre></div>
<p><img src="geomorphons-tiled_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<div class="section level3">
<h3 id="important-notes">Important Notes<a class="anchor" aria-label="anchor" href="#important-notes"></a>
</h3>
<ul>
<li>
<strong>Overhead:</strong> For small datasets like
<code>salton</code>, the overhead of setting up parallel sessions and
tiling the data will make the process <em>slower</em> than a simple
sequential calculation. The benefits of parallel processing become
apparent with larger rasters.</li>
<li>
<strong><code>future.seed = TRUE</code>:</strong> Using
<code>future.seed = TRUE</code> is highly recommended to ensure that any
random number generation is handled properly across the parallel
sessions, making your results reproducible.</li>
<li>
<strong>Backend Flexibility:</strong> The <code>future</code>
package allows for many different parallel backends. The
<code><a href="../reference/geomorphons.html">geomorphons()</a></code> code remains exactly the same.</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="beyond-parallelism-the-flexibility-of-lapply-fun">Beyond Parallelism: The Flexibility of <code>LAPPLY.FUN</code><a class="anchor" aria-label="anchor" href="#beyond-parallelism-the-flexibility-of-lapply-fun"></a>
</h2>
<p>While <code><a href="https://future.apply.futureverse.org/reference/future_lapply.html" class="external-link">future.apply::future_lapply</a></code> is the recommended way
to achieve scalable, high-level parallelism, the <code>LAPPLY.FUN</code>
argument is intentionally designed as a generic interface. It is not
locked into the <code>futureverse</code> ecosystem. You can provide
<em>any</em> <strong>R</strong> function that behaves like
<code><a href="https://rdrr.io/r/base/lapply.html" class="external-link">base::lapply()</a></code>, giving you control over how tiles are
processed.</p>
<p>This hook makes the tile-processing loop customizable, allowing for
logging, error handling, or integration with virtually any sequential or
parallel looping mechanism in <strong>R</strong>.</p>
<p>For example:</p>
<ol style="list-style-type: decimal">
<li>
<p><strong>Using Alternative Parallel Backends:</strong> If you
prefer a different parallel framework, such as the one provided by the
base <code>parallel</code> package, you can easily integrate it.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Example using the base R parallel package</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="va">g_forms_par</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geomorphons.html">geomorphons</a></span><span class="op">(</span></span>
<span>    <span class="va">dem</span>,</span>
<span>    search <span class="op">=</span> <span class="fl">10</span>,</span>
<span>    flat <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>    LAPPLY.FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span>, <span class="va">FUN</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">parLapply</a></span><span class="op">(</span><span class="va">cl</span>, <span class="va">X</span>, <span class="va">FUN</span>, <span class="va">...</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Injecting Progress Reporting and Logging:</strong> For
very large datasets, processing can take a long time. You can use
<code>LAPPLY.FUN</code> to create a wrapper function that provides
real-time feedback or writes to a log file as each tile is completed.
This doesn’t require any parallel backend; it simply modifies the loop’s
behavior.</p>
<p>In the example below, we create a custom function that prints a
message before and after processing each tile. Tiles are processed
sequentially with <code><a href="https://rdrr.io/r/base/lapply.html" class="external-link">base::lapply()</a></code></p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define a custom lapply-like function that adds reporting</span></span>
<span><span class="va">reporting_lapply</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span>, <span class="va">FUN</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>    <span class="va">reporting_FUN</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Starting tile #"</span>, <span class="va">i</span>, <span class="st">" at "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">FUN</span><span class="op">(</span><span class="va">i</span>, <span class="va">...</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Finished tile #"</span>, <span class="va">i</span>, <span class="st">" at "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">reporting_FUN</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">g_forms_reported</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geomorphons.html">geomorphons</a></span><span class="op">(</span></span>
<span>    <span class="va">dem</span>,</span>
<span>    search <span class="op">=</span> <span class="fl">10</span>,</span>
<span>    flat <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>    LAPPLY.FUN <span class="op">=</span> <span class="va">reporting_lapply</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This prints a start and end message to the console for every tile
processed, giving you a live view of the progress.</p>
</li>
</ol>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Andrew Brown.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
